<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script type="text/javascript" src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>

<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script>

        // 이벤트 리스너 초기화
        function initializeEventListeners() {
            $("input[name=cartChkBox]").change(getOrderTotalPrice); // 체크박스 변경 시 총 금액 계산
            $("#checkall").click(checkAll); // 전체 선택/해제
            $("input[name=count]").change(function () {
                changeCount(this); // 수량 변경 시 처리
            });
        }

        function setupAjax() {
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");
            return {token, header};
        }

        /** 쿠폰 적용 */
        // function applyCoupon() {
        //     const couponCode = $("#couponCode").val().trim();
        //
        //     if (!couponCode) {
        //         alert("쿠폰 코드를 입력해주세요.");
        //         return;
        //     }
        //
        //     // 마일리지 적용 여부 확인
        //     const mileageApplied = sessionStorage.getItem("mileageApplied") === "true";
        //     if (mileageApplied) {
        //         alert("마일리지를 먼저 사용한 경우 쿠폰을 적용할 수 없습니다. 쿠폰을 먼저 사용해주세요.");
        //         resetMileage(false); // 마일리지 초기화
        //         resetCoupon(false);  // 쿠폰 초기화
        //         return;
        //     }
        //
        //     console.log(`Applying coupon: ${couponCode}`);
        //
        //     const { token, header } = setupAjax();
        //
        //     $.ajax({
        //         url: "/apply",
        //         type: "POST",
        //         contentType: "application/json",
        //         data: JSON.stringify({
        //             couponCode: couponCode,
        //             originalPrice: calculateFinalPrice() // 현재 총 금액 전송
        //         }),
        //         beforeSend: function (xhr) {
        //             xhr.setRequestHeader(header, token);
        //         },
        //         success: function (response) {
        //             if (response === "없는 쿠폰입니다. 다시 시도해주세요.") {
        //                 alert(response);
        //                 $("#couponCode").val(""); // 입력 필드 초기화
        //                 return;
        //             }
        //
        //             const discount = response.discount || 0;
        //
        //             // 할인 금액을 UI와 내부 변수에 반영
        //             $("#discount").val(discount);
        //             discountedTotalPrice = getOrderTotalPrice() - discount;
        //
        //             alert(`쿠폰 적용 완료! 할인 금액: ${discount}원`);
        //             $("#couponCode").prop("disabled", true);
        //             $("#applyCouponButton").text("쿠폰 재등록");
        //             $("#applyCouponButton").attr("onclick", "resetCoupon()");
        //
        //             // 최종 금액 다시 계산
        //             calculateFinalPrice();
        //
        //             // 상태 플래그 저장
        //             sessionStorage.setItem("couponApplied", "true");
        //         },
        //         error: function (xhr) {
        //             alert(xhr.responseJSON?.message || "쿠폰 적용 중 오류가 발생했습니다.");
        //         }
        //     });
        // }


        /** 쿠폰 적용 */
        function applyCoupon() {
            const couponCode = $("#couponCode").val().trim();
            const mileageApplied = sessionStorage.getItem("mileageApplied") === "true";   // 마일리지 적용 여부 확인
            // console.log("Mileage Applied State:", mileageApplied);
            const {token, header} = setupAjax();

            if (!couponCode) {
                alert("쿠폰 코드를 입력해주세요.");
                return;
            }

            if (mileageApplied) {
                alert("마일리지를 이미 사용한 경우 쿠폰을 적용할 수 없습니다. 쿠폰을 먼저 적용해주세요.");
                // 쿠폰과 마일리지 초기화
                resetMileage(false); // 메시지 없이 마일리지 초기화
                resetCoupon(false); // 메시지 없이 쿠폰 초기화
                // 최종 금액 다시 계산
                calculateFinalPrice();
                return;
            }
            console.log(`Applying coupon: ${couponCode}`);


            $.ajax({
                url: "/apply",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    couponCode: couponCode,
                    originalPrice: getOrderTotalPrice() // 현재 총 금액 전송
                }),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function (response) {
                    if (response === "없는 쿠폰입니다. 다시 시도해주세요.") {
                        alert(response);
                        $("#couponCode").val(""); // 입력 필드 초기화
                        return;
                    }

                    let discount = parseFloat(response.discount) || 0; // 명시적으로 숫자로 변환
                    console.log("Discount from server:", discount);
                    console.log("Order total price before discount:", orderTotalPrice);

                    // 할인 금액이 총 금액보다 높은 경우 조정
                    if (discount >= orderTotalPrice) {
                        discount = orderTotalPrice - 1; // 최소 결제 금액 1원 보장
                        alert("쿠폰 적용 후 최소 결제 금액은 1원입니다.");
                    }


                    // 할인 금액을 UI와 내부 변수에 반영
                    $("#discount").val(discount);
                    discountedTotalPrice = getOrderTotalPrice() - discount;


                    // 최종 결제 금액 UI 업데이트
                    $("#orderTotalPrice").text(`${discountedTotalPrice}원`);

                    alert(`쿠폰 적용 완료! 할인 금액: ${discount}원`);
                    $("#couponCode").prop("disabled", true);
                    $("#applyCouponButton").text("쿠폰 재등록");
                    $("#applyCouponButton").attr("onclick", "resetCoupon()");

                    // 최종 금액 다시 계산
                    calculateFinalPrice();

                    // 상태 플래그 저장
                    sessionStorage.setItem("couponApplied", "true");
                },
                error: function (xhr) {
                    alert(xhr.responseJSON?.message || "쿠폰 적용 중 오류가 발생했습니다.");
                }
            });
        }


        // 총 주문 금액 계산
        function getOrderTotalPrice() {
            let orderTotalPrice = 0;
            // 선택된 장바구니 항목들만 계산
            $("input[name=cartChkBox]:checked").each(function () {
                const cartItemId = $(this).val();  // 체크된 아이템 ID
                const price = parseFloat($("#price_" + cartItemId).data("price")) || 0;
                const count = parseInt($("#count_" + cartItemId).val()) || 1;
                let itemTotal = price * count;
                // 가격이 0원이거나 음수인 경우 1원으로 고정되지 않도록 수정
                itemTotal = Math.max(itemTotal, 1);
                $("#totalPrice_" + cartItemId).text(itemTotal + "원");
                // 총 금액에 더함
                orderTotalPrice += itemTotal;
            });
            // 쿠폰 할인 적용 후 금액 계산 (할인된 금액으로 업데이트)
            orderTotalPrice = discountedTotalPrice > 0 ? discountedTotalPrice : orderTotalPrice;
            // 최소 결제 금액 보장 (1원 이상)
            orderTotalPrice = Math.max(orderTotalPrice, 1);
            // 체크된 항목이 없으면 총 금액을 0으로 설정
            if ($("input[name=cartChkBox]:checked").length === 0) {
                orderTotalPrice = 0;
            }
            // UI에 최종 금액 표시
            $("#orderTotalPrice").text(orderTotalPrice + "원");
            return orderTotalPrice;
        }
    </script>
    <script th:inline="javascript">
        let discountedTotalPrice = 0;  // 쿠폰 할인 적용 후 총 금액

        $(document).ready(function () {
            fetchAvailableMileage(); // 마일리지 잔액 가져오기
        });

        function deleteCartItem(obj) {
            var cartItemId = obj.dataset.id;
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var url = "/cartItem/" + cartItemId;

            $.ajax({
                url: url,
                type: "DELETE",
                beforeSend: function (xhr) {
                    /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                    xhr.setRequestHeader(header, token);
                },
                dataType: "json",
                cache: false,
                success: function (result, status) {
                    location.href = '/cart';
                },
                error: function (jqXHR, status, error) {

                    if (jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';
                    } else {
                        alert(jqXHR.responseText);
                    }

                }
            });
        }

        // 수량 변경 시 처리
        // function changeCount(obj) {
        //     const count = parseInt(obj.value) || 1; // 기본값 1
        //     const cartItemId = obj.id.split('_')[1];
        //     const price = parseFloat($("#price_" + cartItemId).data("price")) || 0;
        //     let totalPrice = price * count;
        //
        //     // 가격이 0원이거나 음수인 경우 1원으로 고정
        //     totalPrice = Math.max(totalPrice, 1);
        //
        //     $("#totalPrice_" + cartItemId).text(totalPrice + "원");
        //     getOrderTotalPrice();
        //     updateCartItemCount(cartItemId, count);
        // }

        // 수량 변경 시 처리
        function changeCount(obj) {
            console.log("changeCount called"); // 호출 횟수 확인

            const count = parseInt(obj.value) || 1;
            const cartItemId = obj.id.split('_')[1];
            const price = parseFloat($("#price_" + cartItemId).data("price")) || 0;
            let totalPrice = price * count;
            totalPrice = Math.max(totalPrice, 1);

            $("#totalPrice_" + cartItemId).text(totalPrice + "원");
            getOrderTotalPrice();
            updateCartItemCount(cartItemId, count);

            // 마일리지와 쿠폰 입력 여부 확인
            const mileageInput = $("#mileageToUse").val().trim();
            const couponInput = $("#couponCode").val().trim();

            if (!mileageInput && !couponInput) {
                console.log(`cart:${cartItemId} - No mileage or coupon applied, skipping.`);
                return; // 마일리지와 쿠폰이 없으면 초기화 및 로그 생략
            }

            // 중복 호출 제거: 마일리지 및 쿠폰 초기화 호출
            resetMileage();
            resetCoupon();

            // 메시지 표시 (한 번만)
            console.log(`cart:${cartItemId} changeCount called`);
            alert("상품 수량 변경으로 인해 쿠폰 및 마일리지가 초기화되었습니다.");
        }


        // 장바구니 전체 선택/해제
        function checkAll() {
            const isChecked = $("#checkall").prop("checked");
            $("input[name=cartChkBox]").prop("checked", isChecked);
            getOrderTotalPrice();
        }

        // 장바구니 수량 업데이트
        function updateCartItemCount(cartItemId, count) {
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: `/cartItem/${cartItemId}?count=${count}`,
                type: "PATCH",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function () {
                    console.log("장바구니 상품 갯수 추가!!!!!.");
                },
                error: handleAjaxError
            });
        }

        /** 주문 처리 */
        function handleOrder() {
            const cartItems = collectCartItems();  // 선택된 장바구니 아이템을 가져옵니다.

            if (!cartItems) {
                return;  // 선택된 아이템이 없으면 함수 종료
            }

            const itemNames = cartItems.map(item => $("#name_" + item.itemId).text());  // 선택된 상품명들
            let productName = itemNames[0] || "상품 없음";  // 상품명이 없으면 "상품 없음"
            if (itemNames.length > 1) productName += ` 외 ${itemNames.length - 1}개`;  // 여러 개의 상품이 선택되었을 경우

            // calculateFinalPrice()를 호출하여 마일리지 적용 후 금액을 계산
            let amountToPay = calculateFinalPrice();  // 마일리지 적용 후 최종 결제 금액
            amountToPay = Math.max(amountToPay, 1);  // 최소 결제 금액 1원

            // 1. 결제 처리 (결제 요청)
            requestPay(productName, amountToPay, function (paymentSuccess) {
                if (paymentSuccess) {
                    // 결제 성공 후 마일리지 사용 및 적립 처리 API 호출
                    const mileageUsed = parseInt($("#previousMileageUsed").val()) || 0;  // 사용된 마일리지
                    const orderData = {
                        purchaseAmount: amountToPay,   // 최종 결제 금액
                        mileageUsed: mileageUsed // 사용된 마일리지
                    };

                    $.ajax({
                        url: "/api/mileage/process-order",  // 서버에서 결제 처리
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(orderData),  // 사용된 마일리지와 결제 금액 전달
                        beforeSend: function (xhr) {
                            const token = $("meta[name='_csrf']").attr("content");  // CSRF 토큰 가져오기
                            const header = $("meta[name='_csrf_header']").attr("content");  // CSRF 헤더 가져오기
                            xhr.setRequestHeader(header, token);  // CSRF 토큰을 요청 헤더에 추가
                        },
                        success: function (response) {
                            console.log("Order processed successfully.");
                            alert("주문이 완료되었습니다.");
                            window.location.href = '/orders';  // 예시로 주문 내역 페이지로 이동
                        },
                        error: function (error) {
                            console.log("Error processing order:", error);
                            alert("주문 처리 중 오류가 발생했습니다.");
                        }
                    });
                } else {
                    alert("결제 취소되었습니다.");
                }
            });
        }

        /** 결제 처리 */
        function requestPay(productName, amountToPay, callback) {

            const userInfo = {
                name: '[[${member.name}]]',
                email: '[[${member.email}]]',
                addr: '[[${member.address}]]'
            };

            const buyerName = userInfo.name.replace(/[^a-zA-Z0-9가-힣\s]/g, '');
            const buyerEmail = userInfo.email.replace(/[^a-zA-Z0-9@._+-]/g, '');
            const buyerAddr = userInfo.addr.replace(/[^a-zA-Z0-9가-힣\s]/g, '');
            console.log("Buyer Address:", buyerAddr);

            const IMP = window.IMP;
            IMP.init("imp07018502");  // IAMPORT 초기화

            IMP.request_pay({
                channelKey: "channel-key-55bfe3cc-6996-46c1-94a5-7bbb1611709b",
                pay_method: "card",
                merchant_uid: `order_${new Date().getTime()}`,
                name: productName,
                amount: amountToPay,  // 최종 결제 금액 (calculateFinalPrice에서 계산된 금액 사용)
                buyer_email: buyerEmail,
                buyer_name: buyerName,
                buyer_tel: "01012345678",
                buyer_addr: buyerAddr
                // buyer_postcode: "123-456" //우편번호
            }, function (rsp) {
                if (rsp.success) {
                    order(amountToPay);  // 결제 성공 시 주문 처리
                    console.log("Payment succeeded:", rsp);
                    callback(true);  // 결제 성공 시 콜백 호출
                } else {
                    console.log("Payment failed:", rsp.error_msg);
                    callback(false);  // 결제 실패 시 콜백 호출
                }
            });
        }

        // 주문 요청
        function order() {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            // 장바구니 아이템들 정보를 배열로 수집
            var cartItems = [];
            $("input[name=cartChkBox]:checked").each(function () {
                var cartItemId = $(this).val();
                var count = $("#count_" + cartItemId).val();
                var totalAmount = $("#totalPrice_" + cartItemId).text().replace('원', '').trim();

                cartItems.push({
                    cartItemId: cartItemId,  // 상품 ID
                    count: count,            // 수량
                    totalAmount: totalAmount // 총 금액
                });
            });

            // 장바구니에 선택된 아이템이 없으면 에러 처리
            if (cartItems.length === 0) {
                alert("주문할 상품을 선택해주세요.");
                return;
            }

            var url = "/cart/orders";  // 주문 처리 URL
            var paramData = {
                cartOrderDtoList: cartItems,
                usedMileage: $("#previousMileageUsed").val() // 마일리지 차감액 추가
            };

            var param = JSON.stringify(paramData);

            console.log(param);  // 전송되는 데이터 확인

            // AJAX 요청 보내기
            $.ajax({
                url: url,
                type: "POST",
                contentType: "application/json",
                data: param,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);  // CSRF 토큰 헤더에 추가
                },
                dataType: "json",
                cache: false,
                success: function (result, status) {
                    // 주문 완료 후 주문 목록 페이지로 이동
                    alert("주문이 완료되었습니다.");
                    location.href = '/orders';  // 주문 완료 후 주문 목록 페이지로 이동
                },
                error: function (jqXHR, status, error) {
                    if (jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';  // 로그인 페이지로 이동
                    } else {
                        alert("오류 발생: " + (jqXHR.responseJSON ? jqXHR.responseJSON.message : error));  // 오류 메시지 출력
                    }
                }
            });
        }

        // 장바구니 아이템 수집
        function collectCartItems() {
            const cartItems = [];
            $("input[name=cartChkBox]:checked").each(function () {
                const cartItemId = $(this).val();  // 체크된 아이템의 ID를 가져옵니다.
                const count = $("#count_" + cartItemId).val();  // 해당 아이템의 수량을 가져옵니다.

                cartItems.push({
                    itemId: cartItemId,  // 상품 ID
                    count: count,        // 수량
                });
            });

            if (!cartItems.length) {
                alert("주문할 상품을 선택해주세요.");  // 아무것도 선택되지 않은 경우 경고
                return null;
            }

            return cartItems;
        }


        // AJAX 에러 처리
        function handleAjaxError(jqXHR) {
            if (jqXHR.status === 401) {
                alert("로그인이 필요합니다!");
                location.href = "/members/login";
            } else {
                alert(jqXHR.responseJSON?.message || "오류가 발생했습니다.");
            }
        }

        /*마일리지 사용*/
        function applyMileage() {
            const mileageToUseInput = $("#mileageToUse");
            const cartItems = collectCartItems();
            let mileageToUse = mileageToUseInput.val().trim(); // 입력값에서 공백 제거
            const originalAvailableMileage = parseInt($("#availableMileage").data("original")) || 0; // 초기 잔액
            const totalPrice = getOrderTotalPrice(); // 총 상품 금액 (상품 가격 합산)

            // 최종적으로 마일리지 적용 상태를 세션에 저장
            sessionStorage.setItem("mileageApplied", "true");

            // 사용 가능한 최대 마일리지 계산 (최소 결제 금액 1원 보장)
            const maxUsableMileage = Math.min(originalAvailableMileage, totalPrice - 1);

            if (!cartItems.length) {
                alert("주문할 상품을 선택해주세요.");  // 아무것도 선택되지 않은 경우 경고
                return null;
            }

            // 빈 입력값 검증
            if (!mileageToUse) {
                alert("사용할 마일리지를 입력해주세요.");
                mileageToUseInput.val(""); // 잘못된 값 초기화
                return;
            }

            // 문자 입력값 검증
            if (!/^\d+$/.test(mileageToUse)) { // 숫자가 아닌 값 검증
                alert("사용할 마일리지는 숫자만 입력할 수 있습니다.");
                mileageToUseInput.val(""); // 잘못된 값 초기화
                return;
            }

            mileageToUse = parseInt(mileageToUse); // 검증된 값만 숫자로 변환

            // 음수 입력값 검증
            if (mileageToUse <= 0) {
                alert("사용할 마일리지를 입력해주세요.");
                mileageToUseInput.val(""); // 잘못된 값 초기화
                return;
            }

            // 보유한 마일리지보다 높은 값을 입력한 경우
            if (mileageToUse > originalAvailableMileage) {
                alert("마일리지가 부족합니다. 보유한 마일리지를 확인해주세요.");
                mileageToUseInput.val(originalAvailableMileage); // 보유 마일리지로 입력값 초기화
                return;
            }

            // 최대 사용 가능 마일리지 초과 검증
            if (mileageToUse > maxUsableMileage) {
                alert(`마일리지는 상품 가격을 초과할 수 없습니다. 최대 ${maxUsableMileage}원까지만 사용 가능합니다.`);
                mileageToUse = maxUsableMileage;
                mileageToUseInput.val(mileageToUse); // 입력 필드 업데이트
            }

            // 남은 마일리지 계산
            const remainingMileage = originalAvailableMileage - mileageToUse;

            // UI 상에서 반영
            console.log(`Applying mileage: ${mileageToUse}`);
            $("#availableMileage").text(remainingMileage); // UI 잔액 업데이트
            $("#previousMileageUsed").val(mileageToUse); // 현재 사용량 저장
            mileageToUseInput.prop("disabled", true); // 입력 필드 비활성화

            // 버튼 텍스트 변경
            $("#applyMileageButton").text("마일리지 재설정"); // 버튼 텍스트 변경
            $("#applyMileageButton").attr("onclick", "resetMileage()"); // 버튼 동작 변경

            // 최종 금액 다시 계산
            calculateFinalPrice(); // 최종 금액 계산 함수 호출

            alert(`마일리지 ${mileageToUse}원이 사용되었습니다.`);
        }

        /** 쿠폰 초기화 */
        // function resetCoupon(showAlert = true) {
        //     console.log("Resetting coupon...");
        //
        //     // 할인 금액 초기화
        //     $("#discount").val(0);
        //
        //     // 쿠폰 입력 필드 및 버튼 초기화
        //     $("#couponCode").val("").prop("disabled", false);
        //     $("#applyCouponButton").text("쿠폰 적용").attr("onclick", "applyCoupon()");
        //
        //     // 상태 플래그 제거
        //     sessionStorage.removeItem("couponApplied");
        //
        //     // 금액 재계산
        //     calculateFinalPrice();
        //
        //     if (showAlert) {
        //         alert("쿠폰이 초기화되었습니다.");
        //     }
        // }

        /** 쿠폰 초기화 */
        function resetCoupon(showAlert = true) {
            resetMileage();

            // 할인 금액 초기화
            $("#discount").val(0);
            discountedTotalPrice = 0; // 내부 변수 초기화

            // 쿠폰 입력 필드 및 버튼 초기화
            $("#couponCode").val("").prop("disabled", false);
            $("#applyCouponButton").text("쿠폰 적용").attr("onclick", "applyCoupon()");

            // 상태 플래그 제거
            sessionStorage.removeItem("couponApplied");

            // 금액 재계산
            calculateFinalPrice(); // 초기 금액 복원

        }

        /** 마일리지 초기화 */
        // function resetMileage(showMessage = true) {
        //     const originalAvailableMileage = parseInt($("#availableMileage").data("original")) || 0;
        //
        //     // 입력 필드 초기화
        //     $("#mileageToUse").val("").prop("disabled", false);
        //     $("#applyMileageButton").text("마일리지 사용").attr("onclick", "applyMileage()");
        //     $("#availableMileage").text(originalAvailableMileage); // 잔액 초기화
        //     $("#previousMileageUsed").val(0); // 사용량 초기화
        //
        //     // 상태 플래그 제거
        //     sessionStorage.removeItem("mileageApplied");
        //
        //
        //     // 최종 금액 다시 계산
        //     calculateFinalPrice();
        //
        //     if (showMessage) {
        //         alert("마일리지가 초기화되었습니다.");
        //     }
        // }
        function resetMileage(showMessage = true) {
            const originalAvailableMileage = parseInt($("#availableMileage").data("original")) || 0;

            // 입력 필드 초기화
            $("#mileageToUse").val("").prop("disabled", false);
            $("#applyMileageButton").text("마일리지 사용").attr("onclick", "applyMileage()");
            $("#availableMileage").text(originalAvailableMileage); // 잔액 초기화
            $("#previousMileageUsed").val(0); // 사용량 초기화

            // 상태 플래그 제거
            sessionStorage.removeItem("mileageApplied");

            // 최종 금액 다시 계산
            calculateFinalPrice();

        }

        // 마일리지 재입력 버튼 클릭 시
        $("#applyMileageButton").on("click", function () {
            resetMileage(); // 팝업 메시지가 표시되도록 호출
            alert("마일리지가 초기화되었습니다.");
        });

        $("#applyCouponButton").on("click", function () {
            resetCoupon();
            alert("쿠폰이 초기화되었습니다. 다시 입력해주세요.");
        });

        /** 최종 결제 금액 계산 */
        function calculateFinalPrice() {
            let orderTotalPrice = getOrderTotalPrice();


            // 마일리지 사용 금액 가져오기
            const mileageUsed = parseInt($("#previousMileageUsed").val()) || 0;
            orderTotalPrice -= mileageUsed;

            // 할인 금액 반영
            const discount = parseInt($("#discount").val()) || 0;
            orderTotalPrice -= discount;

            // 최종 결제 금액을 1원 이상으로 보장
            orderTotalPrice = Math.max(orderTotalPrice, 1);

            // UI 업데이트
            $("#orderTotalPrice").text(orderTotalPrice + "원");

            return orderTotalPrice;
        }

        /** 마일리지 잔액 가져오기 */
        function fetchAvailableMileage() {
            $.ajax({
                url: "/api/mileage/summary", // 서버에서 마일리지 잔액 요청
                type: "GET",
                success: function (data) {
                    const totalMileage = data.totalMileage || 0;
                    $("#availableMileage").text(totalMileage); // 서버에서 받은 잔액 반영
                    $("#availableMileage").data("original", totalMileage); // 초기 잔액 동기화
                    console.log("Fetched available mileage:", totalMileage);
                },
                error: function (xhr) {
                    console.error("Failed to fetch mileage:", xhr.responseText);
                }
            });
        }

    </script>
</th:block>

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
    <style>
        .content-mg {
            margin-left: 25%;
            margin-right: 25%;
            margin-top: 2%;
            margin-bottom: 100px;
        }

        .repImgDiv {
            margin-right: 15px;
            margin-left: 15px;
            height: auto;
        }

        .repImg {
            height: 100px;
            width: 100px;
        }

        .fs18 {
            font-size: 18px
        }

        .fs24 {
            font-size: 24px
        }
    </style>
</th:block>

<div layout:fragment="content" class="content-mg">

    <h2 class="mb-4">
        장바구니 목록
    </h2>

    <div>

        <table class="table">
            <colgroup>
                <col width="15%"/>
                <col width="70%"/>
                <col width="15%"/>
            </colgroup>
            <thead>
            <tr class="text-center">
                <td>
                    <input type="checkbox" id="checkall" onclick="checkAll()"> 전체선택
                </td>
                <td>상품정보</td>
                <td>상품금액</td>
            </tr>
            </thead>
            <tbody>
            <tr th:each="cartItem : ${cartItems}">
                <td class="text-center align-middle">
                    <input type="checkbox" name="cartChkBox" th:value="${cartItem.cartItemId}">
                </td>
                <td class="d-flex">
                    <div class="repImgDiv align-self-center">
                        <img th:src="${cartItem.imgUrl}" class="rounded repImg" th:alt="${cartItem.itemNm}">
                    </div>
                    <div class="align-self-center">
                        <span th:id="'name_' + ${cartItem.cartItemId}" th:text="${cartItem.itemNm}"
                              class="fs24 font-weight-bold"></span>
                        <div class="fs18 font-weight-light">
                            <span th:id="'price_' + ${cartItem.cartItemId}"
                                  th:data-price="${cartItem.price}"
                                  th:text="${cartItem.price} + '원'" class="align-self-center mr-2">
                            </span>
                            <input type="number" name="count" th:id="'count_' + ${cartItem.cartItemId}"
                                   th:value="${cartItem.count}" min="1"
                                   onchange="changeCount(this)" class="form-control mr-2">
                            <button type="button" class="close" aria-label="Close">
                                <span aria-hidden="true" th:data-id="${cartItem.cartItemId}"
                                      onclick="deleteCartItem(this)">&times;</span>
                            </button>
                        </div>
                    </div>
                </td>
                <td class="text-center align-middle">
                    <span th:id="'totalPrice_' + ${cartItem.cartItemId}"
                          name="totalPrice" th:text="${cartItem.price * cartItem.count} + '원'">
                    </span>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="text-right">
            <!-- 숨겨진 필드 -->
            <input type="hidden" id="previousMileageUsed" value="0">
            <h5>마일리지 잔액: <span id="availableMileage" data-original="0">0</span>원</h5>
        </div>

        <!-- 마일리지 입력 부분 수정 -->
        <h2 class="text-center mt-4">
            <input type="number" id="mileageToUse" class="form-control w-50 mx-auto" placeholder="사용할 마일리지 입력" value="">
            <!-- applyMileageButton 클래스를 추가하여 버튼 선택을 정확히 합니다 -->
            <button type="button" id="applyMileageButton" class="btn btn-outline-dark btn-lg mt-2"
                    onclick="applyMileage()">마일리지 사용
            </button>
        </h2>

        <h2 class="text-center">
            <input type="text" id="couponCode" class="form-control w-50 mx-auto" placeholder="쿠폰 코드 입력">
            총 주문 금액 : <span id="orderTotalPrice" class="text-danger">0원</span>
        </h2>

        <div class="text-center mt-3">
            <button type="button" class="btn btn-outline-dark" onclick="handleOrder()">주문하기</button>
            <button type="button" id="applyCouponButton" class="btn btn-outline-dark" onclick="applyCoupon()">쿠폰 적용하기
            </button>
        </div>
    </div>
</div>